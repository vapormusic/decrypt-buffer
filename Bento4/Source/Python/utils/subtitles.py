#!/usr/bin/env python
__author__    = 'Gilles Boccon-Gibod (bok@bok.net)'
__copyright__ = 'Copyright 2011-2016 Axiomatic Systems, LLC.'

import xml.etree.ElementTree as ET
import os.path
from mp4utils import LanguageCodeMap

TTML_XML_NAMESPACE = 'http://www.w3.org/ns/ttml'
XML_NAMESPACE      = 'http://www.w3.org/XML/1998/namespace'

LanguageNames = {
    "aa": 'Qafara',
    "ab": '\xd0\x90\xd2\xa7\xd1\x81\xd1\x83\xd0\xb0',
    "ae": 'Avesta',
    "af": 'Afrikaans',
    "ak": 'Akana',
    "am": '\xe1\x8a\xa0\xe1\x88\x9b\xe1\x88\xad\xe1\x8a\x9b',
    "an": 'Aragon\xc3\xa9s',
    "ar": '\xd8\xa7\xd9\x84\xd8\xb9\xd8\xb1\xd8\xa8\xd9\x8a\xd8\xa9',
    "as": '\xe0\xa6\x85\xe0\xa6\xb8\xe0\xa6\xae\xe0\xa7\x80\xe0\xa6\xaf\xe0\xa6\xbc\xe0\xa6\xbe',
    "av": '\xd0\xb0\xd0\xb2\xd0\xb0\xd1\x80 \xd0\xbc\xd0\xb0\xd1\x86\xd3\x80; \xd0\xbc\xd0\xb0\xd0\xb3\xd3\x80\xd0\xb0\xd1\x80\xd1\x83\xd0\xbb \xd0\xbc\xd0\xb0\xd1\x86\xd3\x80',
    "ay": 'Aymar Aru',
    "az": 'Az\xc9\x99rbaycanca',
    "ba": '\xd0\xb1\xd0\xb0\xd1\x88\xd2\xa1\xd0\xbe\xd1\x80\xd1\x82 \xd1\x82\xd0\xb5\xd0\xbb\xd0\xb5',
    "be": '\xd0\x91\xd0\xb5\xd0\xbb\xd0\xb0\xd1\x80\xd1\x83\xd1\x81\xd0\xba\xd0\xb0\xd1\x8f \xd0\xbc\xd0\xbe\xd0\xb2\xd0\xb0',
    "bg": '\xd0\xb1\xd1\x8a\xd0\xbb\xd0\xb3\xd0\xb0\xd1\x80\xd1\x81\xd0\xba\xd0\xb8 \xd0\xb5\xd0\xb7\xd0\xb8\xd0\xba',
    "bh": '\xe0\xa4\xad\xe0\xa5\x8b\xe0\xa4\x9c\xe0\xa4\xaa\xe0\xa5\x81\xe0\xa4\xb0\xe0\xa5\x80',
    "bi": 'Bislama',
    "bm": 'Bamanankan',
    "bn": '\xe0\xa6\xac\xe0\xa6\xbe\xe0\xa6\x82\xe0\xa6\xb2\xe0\xa6\xbe',
    "bo": '\xe0\xbd\x96\xe0\xbd\xbc\xe0\xbd\x91\xe0\xbc\x8b\xe0\xbd\xa1\xe0\xbd\xb2\xe0\xbd\x82',
    "br": 'Brezhoneg',
    "bs": 'Bosanski',
    "ca": 'Catal\xc3\xa0',
    "ce": '\xd0\xbd\xd0\xbe\xd1\x85\xd1\x87\xd0\xb8\xd0\xb9\xd0\xbd \xd0\xbc\xd0\xbe\xd1\x82\xd1\x82',
    "ch": 'Chamoru',
    "co": 'Corsu',
    "cr": '\xe1\x93\x80\xe1\x90\xa6\xe1\x90\x83\xe1\x94\xad\xe1\x90\x8d\xe1\x90\x8f\xe1\x90\xa3',
    "cs": '\xc4\x8de\xc5\xa1tina',
    "cu": '\xd1\xa9\xd0\xb7\xd1\x8b\xd0\xba\xd1\x8a \xd1\x81\xd0\xbb\xd0\xbe\xd0\xb2\xd1\xa3\xd0\xbd\xd1\x8c\xd1\x81\xd0\xba\xd1\x8a',
    "cv": '\xd1\x87\xd3\x91\xd0\xb2\xd0\xb0\xd1\x88 \xd1\x87\xd3\x97\xd0\xbb\xd1\x85\xd0\xb8',
    "cy": 'Cymraeg',
    "da": 'Dansk',
    "de": 'Deutsch',
    "dz": '\xe0\xbd\xa2\xe0\xbe\xab\xe0\xbd\xbc\xe0\xbd\x84\xe0\xbc\x8b\xe0\xbd\x81',
    "ee": '\xc6\x90\xca\x8b\xc9\x9bgb\xc9\x9b',
    "el": '\xce\x95\xce\xbb\xce\xbb\xce\xb7\xce\xbd\xce\xb9\xce\xba\xce\xac',
    "en": 'English',
    "eo": 'Esperanto',
    "es": 'Espa\xc3\xb1ol',
    "et": 'Eesti Keel',
    "eu": 'Euskara',
    "fa": '\xd9\x81\xd8\xa7\xd8\xb1\xd8\xb3\xdb\x8c',
    "ff": 'Fulfulde',
    "fi": 'Suomi',
    "fj": 'Vosa Vakaviti',
    "fo": 'F\xc3\xb8royskt',
    "fr": 'Fran\xc3\xa7ais',
    "fy": 'Frysk',
    "ga": 'Gaeilge',
    "gd": 'G\xc3\xa0idhlig',
    "gl": 'Galego',
    "gn": "Ava\xc3\xb1e'\xe1\xba\xbd",
    "gu": '\xe0\xaa\x97\xe0\xab\x81\xe0\xaa\x9c\xe0\xaa\xb0\xe0\xaa\xbe\xe0\xaa\xa4\xe0\xab\x80',
    "gv": 'Gaelg; Manninagh',
    "ha": 'Hausanc\xc4\xab; \xd9\x87\xd9\x8e\xd9\x88\xd9\x8f\xd8\xb3\xd9\x8e',
    "he": '\xd7\xa2\xd6\xb4\xd7\x91\xd6\xb0\xd7\xa8\xd6\xb4\xd7\x99\xd7\xaa; \xd7\xa2\xd7\x91\xd7\xa8\xd7\x99\xd7\xaa',
    "hi": '\xe0\xa4\xb9\xe0\xa4\xbf\xe0\xa4\xa8\xe0\xa5\x8d\xe0\xa4\xa6\xe0\xa5\x80',
    "ho": 'Hiri Motu',
    "hr": 'Hrvatski',
    "ht": 'Krey\xc3\xb2l ayisyen',
    "hu": 'Magyar',
    "hy": '\xd5\x80\xd5\xa1\xd5\xb5\xd5\xa5\xd6\x80\xd5\xa5\xd5\xb6 \xd5\xac\xd5\xa5\xd5\xa6\xd5\xb8\xd6\x82',
    "hz": 'Otjiherero',
    "ia": 'Interlingua',
    "id": 'Bahasa Indonesia',
    "ie": 'Interlingue',
    "ig": 'Igbo',
    "ii": '\xea\x86\x87\xea\x89\x99',
    "ik": 'I\xc3\xb1upiaq; I\xc3\xb1upiatun',
    "io": 'Ido',
    "is": '\xc3\xadslenska',
    "it": 'Italiano',
    "iu": '\xe1\x90\x83\xe1\x93\x84\xe1\x92\x83\xe1\x91\x8e\xe1\x91\x90\xe1\x91\xa6',
    "ja": '\xe6\x97\xa5\xe6\x9c\xac\xe8\xaa\x9e',
    "ka": '\xe1\x83\xa5\xe1\x83\x90\xe1\x83\xa0\xe1\x83\x97\xe1\x83\xa3\xe1\x83\x9a\xe1\x83\x98 \xe1\x83\x94\xe1\x83\x9c\xe1\x83\x90 (kartuli ena)',
    "kg": 'Kikongo',
    "ki": 'G\xc4\xa9k\xc5\xa9y\xc5\xa9',
    "kj": 'Kuanyama',
    "kk": '\xd2\x9a\xd0\xb0\xd0\xb7\xd0\xb0\xd2\x9b \xd1\x82\xd1\x96\xd0\xbb\xd1\x96',
    "kl": 'Kalaallisut',
    "km": '\xe1\x9e\x97\xe1\x9e\xb6\xe1\x9e\x9f\xe1\x9e\xb6\xe1\x9e\x81\xe1\x9f\x92\xe1\x9e\x98\xe1\x9f\x82\xe1\x9e\x9a',
    "kn": '\xe0\xb2\x95\xe0\xb2\xa8\xe0\xb3\x8d\xe0\xb2\xa8\xe0\xb2\xa1',
    "ko": '\xed\x95\x9c\xea\xb5\xad\xec\x96\xb4 (\xe9\x9f\x93\xe5\x9c\x8b\xe8\xaa\x9e); \xec\xa1\xb0\xec\x84\xa0\xeb\xa7\x90 (\xe6\x9c\x9d\xe9\xae\xae\xe8\xaa\x9e)',
    "kr": 'Kanuri',
    "ks": '\xe0\xa4\x95\xe0\xa5\x89\xe0\xa4\xb6\xe0\xa5\x81\xe0\xa4\xb0; \xda\xa9\xd9\xb2\xd8\xb4\xd9\x8f\xd8\xb1',
    "ku": 'Kurd\xc3\xae; \xd9\x83\xd9\x88\xd8\xb1\xd8\xaf\xd9\x8a',
    "kv": '\xd0\xba\xd0\xbe\xd0\xbc\xd0\xb8 \xd0\xba\xd1\x8b\xd0\xb2',
    "kw": 'Kernewek',
    "ky": '\xd0\xba\xd1\x8b\xd1\x80\xd0\xb3\xd1\x8b\xd0\xb7 \xd1\x82\xd0\xb8\xd0\xbb\xd0\xb8',
    "la": 'latine; lingua Latina',
    "lb": 'L\xc3\xabtzebuergesch',
    "lg": 'Luganda',
    "li": 'Limburgs',
    "ln": 'Lingala',
    "lo": '\xe0\xba\x9e\xe0\xba\xb2\xe0\xba\xaa\xe0\xba\xb2\xe0\xba\xa5\xe0\xba\xb2\xe0\xba\xa7',
    "lt": 'Lietuvi\xc5\xb3 Kalba',
    "lv": 'Latvie\xc5\xa1u Valoda',
    "mg": 'Malagasy fiteny',
    "mh": 'Kajin M\xcc\xa7aje\xc4\xbc',
    "mi": 'Te Reo M\xc4\x81ori',
    "mk": '\xd0\xbc\xd0\xb0\xd0\xba\xd0\xb5\xd0\xb4\xd0\xbe\xd0\xbd\xd1\x81\xd0\xba\xd0\xb8 \xd1\x98\xd0\xb0\xd0\xb7\xd0\xb8\xd0\xba',
    "ml": '\xe0\xb4\xae\xe0\xb4\xb2\xe0\xb4\xaf\xe0\xb4\xbe\xe0\xb4\xb3\xe0\xb4\x82',
    "mn": '\xd0\xbc\xd0\xbe\xd0\xbd\xd0\xb3\xd0\xbe\xd0\xbb \xd1\x85\xd1\x8d\xd0\xbb',
    "mr": '\xe0\xa4\xae\xe0\xa4\xb0\xe0\xa4\xbe\xe0\xa4\xa0\xe0\xa5\x80',
    "ms": 'Bahasa Melayu; \xd8\xa8\xd9\x87\xd8\xa7\xd8\xb3 \xd9\x85\xd9\x84\xd8\xa7\xd9\x8a\xd9\x88',
    "mt": 'Malti',
    "my": '\xe1\x80\x99\xe1\x80\xbc\xe1\x80\x94\xe1\x80\xba\xe1\x80\x99\xe1\x80\xac\xe1\x80\x85\xe1\x80\xac',
    "na": 'Ekakair\xc5\xa9 Naoero',
    "nb": 'Bokm\xc3\xa5l',
    "nd": 'isiNdebele',
    "ne": '\xe0\xa4\xa8\xe0\xa5\x87\xe0\xa4\xaa\xe0\xa4\xbe\xe0\xa4\xb2\xe0\xa5\x80',
    "ng": 'Owambo',
    "nl": 'Nederlands',
    "nn": 'Nynorsk',
    "no": 'Norsk',
    "nr": 'isiNdebele',
    "nv": 'Din\xc3\xa9 bizaad; Din\xc3\xa9k\xca\xbceh\xc7\xb0\xc3\xad',
    "ny": 'chiChe\xc5\xb5a; chinyanja',
    "oc": 'Occitan',
    "oj": '\xe1\x90\x8a\xe1\x93\x82\xe1\x94\x91\xe1\x93\x87\xe1\x90\xaf\xe1\x92\xa7\xe1\x90\x8f\xe1\x90\xa3 (Anishinaabemowin)',
    "om": 'Afaan Oromoo',
    "or": '\xe0\xac\x93\xe0\xac\xa1\xe0\xac\xbc\xe0\xac\xbf\xe0\xac\x86',
    "os": '\xd0\xb8\xd1\x80\xd0\xbe\xd0\xbd \xd3\x95\xd0\xb2\xd0\xb7\xd0\xb0\xd0\xb3',
    "pa": '\xe0\xa8\xaa\xe0\xa9\xb0\xe0\xa8\x9c\xe0\xa8\xbe\xe0\xa8\xac\xe0\xa9\x80; \xd9\xbe\xd9\x86\xd8\xac\xd8\xa7\xd8\xa8\xdb\x8c',
    "pi": '\xe0\xa4\xaa\xe0\xa4\xbe\xe0\xa4\xb2\xe0\xa4\xbf',
    "pl": 'Polski',
    "ps": '\xd9\xbe\xda\x9a\xd8\xaa\xd9\x88',
    "pt": 'Portugu\xc3\xaas',
    "qu": 'Runa Simi; Kichwa',
    "rm": 'Rumantsch Grischun',
    "rn": 'Rundi',
    "ro": 'Rom\xc3\xa2n\xc4\x83',
    "ru": '\xd1\x80\xd1\x83\xd1\x81\xd1\x81\xd0\xba\xd0\xb8\xd0\xb9 \xd1\x8f\xd0\xb7\xd1\x8b\xd0\xba',
    "rw": 'Ikinyarwanda',
    "sa": '\xe0\xa4\xb8\xe0\xa4\x82\xe0\xa4\xb8\xe0\xa5\x8d\xe0\xa4\x95\xe0\xa5\x83\xe0\xa4\xa4\xe0\xa4\xae\xe0\xa5\x8d',
    "sc": 'Sardu',
    "sd": '\xd8\xb3\xd9\x86\xda\x8c\xd9\x8a\xd8\x8c \xd8\xb3\xd9\x86\xd8\xaf\xda\xbe\xdb\x8c; \xe0\xa4\xb8\xe0\xa4\xbf\xe0\xa4\xa8\xe0\xa5\x8d\xe0\xa4\xa7\xe0\xa5\x80',
    "se": 's\xc3\xa1mi; s\xc3\xa1megiella',
    "sg": 'y\xc3\xa2ng\xc3\xa2 t\xc3\xae s\xc3\xa4ng\xc3\xb6',
    "si": '\xe0\xb7\x83\xe0\xb7\x92\xe0\xb6\x82\xe0\xb7\x84\xe0\xb6\xbd',
    "sk": 'Sloven\xc4\x8dina',
    "sl": 'Sloven\xc5\xa1\xc4\x8dina',
    "sm": "Gagana fa'a Samoa",
    "sn": 'chiShona',
    "so": 'Soomaaliga; af Soomaali',
    "sq": 'Shqip',
    "sr": '\xd1\x81\xd1\x80\xd0\xbf\xd1\x81\xd0\xba\xd0\xb8 \xd1\x98\xd0\xb5\xd0\xb7\xd0\xb8\xd0\xba; srpski jezik',
    "ss": 'siSwati',
    "st": 'Sesotho',
    "su": 'Basa Sunda',
    "sv": 'Svenska',
    "sw": 'Kiswahili',
    "ta": '\xe0\xae\xa4\xe0\xae\xae\xe0\xae\xbf\xe0\xae\xb4\xe0\xaf\x8d',
    "te": '\xe0\xb0\xa4\xe0\xb1\x86\xe0\xb0\xb2\xe0\xb1\x81\xe0\xb0\x97\xe0\xb1\x81',
    "tg": '\xd1\x82\xd0\xbe\xd2\xb7\xd0\xb8\xd0\xba\xd3\xa3; \xd8\xaa\xd8\xa7\xd8\xac\xdb\x8c\xda\xa9\xdb\x8c',
    "th": '\xe0\xb8\xa0\xe0\xb8\xb2\xe0\xb8\xa9\xe0\xb8\xb2\xe0\xb9\x84\xe0\xb8\x97\xe0\xb8\xa2',
    "ti": '\xe1\x89\xb5\xe1\x8c\x8d\xe1\x88\xad\xe1\x8a\x9b',
    "tk": '\xd0\xa2\xd2\xaf\xd1\x80\xd0\xba\xd0\xbc\xd0\xb5\xd0\xbd',
    "tl": 'Wikang Tagalog; \xe1\x9c\x8f\xe1\x9c\x92\xe1\x9c\x83\xe1\x9c\x85\xe1\x9c\x94 \xe1\x9c\x86\xe1\x9c\x84\xe1\x9c\x8e\xe1\x9c\x93\xe1\x9c\x84\xe1\x9c\x94',
    "tn": 'Setswana',
    "to": 'Faka-Tonga',
    "tr": 'T\xc3\xbcrk\xc3\xa7e',
    "ts": 'Xitsonga',
    "tt": '\xd1\x82\xd0\xb0\xd1\x82\xd0\xb0\xd1\x80\xd1\x87\xd0\xb0; tatar\xc3\xa7a; \xd8\xaa\xd8\xa7\xd8\xaa\xd8\xa7\xd8\xb1\xda\x86\xd8\xa7',
    "tw": 'Twi',
    "ty": 'te reo Tahiti; te reo M\xc4\x81\xca\xbcohi',
    "ug": 'Uy\xc6\xa3urq\xc9\x99; Uy\xc4\x9fur\xc3\xa7e; \xd8\xa6\xdb\x87\xd9\x8a\xd8\xba\xdb\x87\xd8\xb1\xda\x86',
    "uk": '\xd1\x83\xd0\xba\xd1\x80\xd0\xb0\xd1\x97\xd0\xbd\xd1\x81\xd1\x8c\xd0\xba\xd0\xb0 \xd0\xbc\xd0\xbe\xd0\xb2\xd0\xb0',
    "ur": '\xd8\xa7\xd8\xb1\xd8\xaf\xd9\x88',
    "uz": "O'zbek; \xd0\x8e\xd0\xb7\xd0\xb1\xd0\xb5\xd0\xba; \xd8\xa3\xdb\x87\xd8\xb2\xd8\xa8\xdb\x90\xd9\x83",
    "ve": 'Tshiven\xe1\xb8\x93a',
    "vi": 'Ti\xe1\xba\xbfng Vi\xe1\xbb\x87t',
    "vo": 'Volap\xc3\xbck',
    "wa": 'Walon',
    "wo": 'Wolof',
    "xh": 'isiXhosa',
    "yi": '\xd7\x99\xd7\x99\xd6\xb4\xd7\x93\xd7\x99\xd7\xa9',
    "yo": 'Yor\xc3\xb9b\xc3\xa1',
    "za": 'Sa\xc9\xaf cue\xc5\x8b\xc6\x85; Saw cuengh',
    "zh": '\xe6\xbc\xa2\xe8\xaa\x9e; \xe6\xb1\x89\xe8\xaf\xad; \xe4\xb8\xad\xe6\x96\x87',
    "zu": 'isiZulu'
}

class SubtitlesFile:
    def __init__(self, options, media_source):
        self.media_source    = media_source
        self.format          = None

        filename = media_source.filename
        self.media_name = os.path.basename(filename)
        if options.debug:
            print 'Processing Subtitles file', filename

        self.size = os.path.getsize(filename)

        self.language = media_source.spec.get('+language')
        self.language_name = 'Unknown'
        if not self.language:
            self.language = 'unknown'

        if len(self.language) == 3:
            # convert to 2 char code
            self.language = LanguageCodeMap.get(self.language, self.language)
        self.language_name = LanguageNames.get(self.language, self.language_name)

        if media_source.format == 'ttml':
            self.parse_ttml(options)
        elif media_source.format == 'webvtt':
            self.parse_webvtt(options)

        if '+media' in media_source.spec:
            self.media_name = media_source.spec['+media']

    def parse_ttml(self, options):
        self.format    = 'ttml'
        self.mime_type = 'application/ttml+xml'

        xml_tree= ET.parse(self.media_source.filename)
        xml_root = xml_tree.getroot()

        if xml_root.tag != '{'+TTML_XML_NAMESPACE+'}tt':
            if options.debug:
                print 'ERROR: no root level <tt> element found'

        # get the language
        language = xml_root.get('{'+XML_NAMESPACE+'}lang')
        if language:
            self.language = language

        if options.rename_media:
            self.media_name = 'subtitles-'+self.language+'.xml'

    def parse_webvtt(self, options):
        self.format    = 'webvtt'
        self.mime_type = 'text/vtt'
